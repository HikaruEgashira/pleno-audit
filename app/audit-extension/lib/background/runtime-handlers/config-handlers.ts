import type {
  BlockingConfig,
  DataRetentionConfig,
  DetectionConfig,
  DoHMonitorConfig,
  NotificationConfig,
} from "@pleno-audit/extension-runtime";
import type { AsyncHandlerEntry, RuntimeHandlerDependencies } from "./types";

export function createConfigurationHandlers(
  deps: RuntimeHandlerDependencies,
): AsyncHandlerEntry[] {
  return [
    ["GET_DATA_RETENTION_CONFIG", {
      execute: () => deps.getDataRetentionConfig(),
      fallback: () => deps.fallbacks.dataRetentionConfig,
    }],
    ["SET_DATA_RETENTION_CONFIG", {
      execute: (message) => deps.setDataRetentionConfig(message.data as DataRetentionConfig),
      fallback: () => ({ success: false }),
    }],
    ["TRIGGER_DATA_CLEANUP", {
      execute: () => deps.cleanupOldData(),
      fallback: () => ({ deleted: 0 }),
    }],
    ["GET_BLOCKING_CONFIG", {
      execute: () => deps.getBlockingConfig(),
      fallback: () => deps.fallbacks.blockingConfig,
    }],
    ["SET_BLOCKING_CONFIG", {
      execute: (message) => deps.setBlockingConfig(message.data as BlockingConfig),
      fallback: () => ({ success: false }),
    }],
    ["GET_DETECTION_CONFIG", {
      execute: () => deps.getDetectionConfig(),
      fallback: () => deps.fallbacks.detectionConfig,
    }],
    ["SET_DETECTION_CONFIG", {
      execute: (message) => deps.setDetectionConfig(message.data as Partial<DetectionConfig>),
      fallback: () => ({ success: false }),
    }],
    ["GET_NOTIFICATION_CONFIG", {
      execute: () => deps.getNotificationConfig(),
      fallback: () => deps.fallbacks.notificationConfig,
    }],
    ["SET_NOTIFICATION_CONFIG", {
      execute: (message) => deps.setNotificationConfig(message.data as Partial<NotificationConfig>),
      fallback: () => ({ success: false }),
    }],
    ["GET_DOH_MONITOR_CONFIG", {
      execute: () => deps.getDoHMonitorConfig(),
      fallback: () => deps.fallbacks.doHMonitorConfig,
    }],
    ["SET_DOH_MONITOR_CONFIG", {
      execute: (message) => deps.setDoHMonitorConfig(message.data as Partial<DoHMonitorConfig>),
      fallback: () => ({ success: false }),
    }],
    ["GET_DOH_REQUESTS", {
      execute: (message) => deps.getDoHRequests(message.data as {
        limit?: number;
        offset?: number;
      }),
      fallback: () => ({ requests: [], total: 0 }),
    }],
  ];
}
