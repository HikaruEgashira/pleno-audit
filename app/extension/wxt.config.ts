import { defineConfig } from "wxt";

export default defineConfig({
  srcDir: ".",
  // Use separate output dir for dev to avoid conflicts with manually loaded extensions
  outDir: process.env.DEBUG_PORT ? ".wxt-dev" : "dist",
  imports: false,
  webExt: {
    startUrls: ["https://example.com"],
    args: [`--load-extension=../pleno-battacker/${process.env.DEBUG_PORT ? ".wxt-dev" : "dist"}/chrome-mv3`],
  },
  manifest: (env) => {
    const isDev = env.mode === "development";
    const iconPrefix = isDev ? "icon-dev" : "icon";
    const isFirefox = env.browser === "firefox";
    const isSafari = env.browser === "safari";
    const isMV2 = isFirefox || isSafari;

    // Base permissions (cross-browser)
    const basePermissions = ["cookies", "storage", "activeTab", "alarms", "webRequest", "management", "notifications"];

    // Chrome/Edge MV3 permissions
    const mv3Permissions = [...basePermissions, "offscreen", "scripting", "declarativeNetRequest"];

    // Firefox/Safari MV2 permissions (no offscreen, no scripting)
    const mv2Permissions = basePermissions;

    return {
      name: isDev ? "[DEV] Pleno Audit" : "Pleno Audit",
      version: "0.0.1",
      description: "Personal Browser Security",
      icons: {
        16: `${iconPrefix}-16.png`,
        32: `${iconPrefix}-32.png`,
        48: `${iconPrefix}-48.png`,
        128: `${iconPrefix}-128.png`,
      },
      action: {
        default_icon: {
          16: `${iconPrefix}-16.png`,
          32: `${iconPrefix}-32.png`,
          48: `${iconPrefix}-48.png`,
        },
      },
      permissions: isMV2 ? mv2Permissions : mv3Permissions,
      host_permissions: ["<all_urls>"],
      content_security_policy: isMV2
        ? "script-src 'self' 'wasm-unsafe-eval'; object-src 'self';"
        : {
            extension_pages: isDev
              ? "script-src 'self' 'wasm-unsafe-eval' http://localhost:*; object-src 'self'; connect-src 'self' ws://localhost:* http://localhost:*;"
              : "script-src 'self' 'wasm-unsafe-eval'; object-src 'self';",
          },
      web_accessible_resources: isMV2
        ? ["api-hooks.js", "ai-hooks.js", "sql-wasm.wasm", "parquet_wasm_bg.wasm"]
        : [
            {
              resources: ["api-hooks.js", "ai-hooks.js", "sql-wasm.wasm", "parquet_wasm_bg.wasm"],
              matches: ["<all_urls>"],
            },
          ],
      // Static content script registration for MAIN world (MV3 only)
      ...(!isMV2 && {
        content_scripts: [
          {
            js: ["ai-hooks.js"],
            matches: ["<all_urls>"],
            run_at: "document_start",
            world: "MAIN",
          },
        ],
      }),
      // Firefox-specific: browser_specific_settings
      ...(isFirefox && {
        browser_specific_settings: {
          gecko: {
            id: "pleno-audit@example.com",
            strict_min_version: "109.0",
          },
        },
      }),
    };
  },
  vite: () => ({
    plugins: [],
    esbuild: {
      jsx: "automatic",
      jsxImportSource: "preact",
    },
    build: {
      target: "esnext",
      modulePreload: false,
      rollupOptions: {
        external: ["parquet-wasm"],
      },
    },
    define: {
      "import.meta.hot": "undefined",
      "__PLENO_DEV__": "true",
      "__DEBUG_PORT__": JSON.stringify(process.env.DEBUG_PORT || "9222"),
    },
    optimizeDeps: {
      include: [
        "@pleno-audit/csp",
        "@pleno-audit/detectors",
        "@pleno-audit/api",
        "@pleno-audit/extension-runtime",
        "@pleno-audit/parquet-storage",
      ],
      exclude: ["parquet-wasm"],
    },
  }),
});
