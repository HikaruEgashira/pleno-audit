# ADR 038: Background初期化とメッセージ定義の責務分離

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/entrypoints/background.ts` はメッセージ定義・初期化処理・監視登録が単一関数に集約されている
- ランタイムメッセージの定義が1つの巨大Mapに集中し、関心領域ごとの追跡が難しい
- 初期化順の読み解きに時間がかかり、変更時に副作用範囲の見積もりが不安定になる

## 決定

- ランタイムメッセージの定義を関心ごとのエントリ生成関数へ分割する
- direct/async のハンドラ構築を専用関数化し、呼び出し側はディスパッチ責務だけを持つ
- background起動時の副作用処理を用途別の初期化関数に分離し、`bootstrapBackgroundServices` から順序を明示する

## 理由

- 可読性: 変更対象の責務を関数単位で限定できる
- 凝集度: CSP・接続管理・AI/ドメイン検知・ネットワーク設定を独立して扱える
- 変更容易性: 新規メッセージ追加時に既存初期化ロジックへ影響を与えにくい
- 安全性: 起動順序を1か所で維持でき、機能差異の混入リスクを下げる

## リスクと対応

| リスク | 対応 |
|--------|------|
| ハンドラ分割時のキー欠落 | 既存キーをそのまま移送し、ディスパッチ経路は維持する |
| 起動順序変更による副作用 | `register*Listener` の同期登録を最優先のまま保持する |
| フォールバック値の互換性低下 | 既存レスポンス形と同じ値を返す設計を維持する |
