# ADR 045: Runtime Handler定義のファイル分割

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/lib/background/runtime-handlers.ts` は1ファイルに型定義・実行ユーティリティ・各ハンドラの実装が集約されている
- 責務が混在しており、変更時に差分の焦点がぼやける
- ハンドラの種類が増えるほどレビュー時の探索コストが上がる

## 決定

- runtime handler定義を用途別にファイル分割する
- `index.ts` を組み立ての唯一の入口とし、外部APIを維持する
- `runAsyncMessageHandler` と型定義を共通モジュールに置き、他ファイルから参照する

## 理由

- 可読性: 目的別のファイル分割で関心事の境界を明確にする
- 凝集度: 同一ドメインのハンドラを同一ファイルに集約できる
- 変更容易性: 追加・削除時の差分が局所化される
- 品質維持: 外部契約を維持し、内部構造のみを改善する

## リスクと対応

| リスク | 対応 |
|--------|------|
| インポート循環によるビルドエラー | 依存方向を `index.ts` に集約し、共通型に限定する |
| ハンドラ登録漏れ | `createAsyncHandlers` に集約し、エントリ追加を1箇所に固定する |
| メッセージ互換性の破壊 | 既存の type 名・fallback を保持し、実機デバッグで確認する |
