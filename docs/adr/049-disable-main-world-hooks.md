# ADR-049: Main Worldを最小化し非同期キュー制御で負荷を抑える

## Status

Accepted

## Context

ページの Main World で API フックを実行すると、サイト本体と同じ実行コンテキストで同期的な処理が発生する。監査対象ページの体感性能と互換性への影響を最小化するには、Main World 側の処理を最小化する必要がある。

Pleno Audit は ADR-002 により「遮断ではなく発見」を主目的とする。Main World フックを前提とする遮断・介入系の設計は、当該方針と一致しない。

## Decision

- `world: "MAIN"` の注入は維持し、検出イベントの発火のみを担当させる
- Main World 由来イベントは content script 側でキュー化し、非同期バッチで Background に転送する
- 高負荷時はバッチサイズ・送信間隔・低優先イベント頻度を自動調整する
- 重い判定や永続化は Background 側に集約する

## Consequences

- API フック由来の検知（AIプロンプト捕捉、DOM/APIフック検知）を維持する
- 高頻度イベントの同期転送を抑えるため、ページ側の実行時負荷を低減する
- キュー上限超過時は低優先イベントを間引きし、重要検知を優先する
