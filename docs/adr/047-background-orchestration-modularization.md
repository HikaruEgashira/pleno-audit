# ADR 047: Backgroundオーケストレーションの責務分離

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/entrypoints/background.ts` に初期化、メッセージルーティング、DoH監視、アラーム登録が同居し、変更影響の境界が曖昧になっていた
- 拡張機能の起動順序や責務が一箇所に集まり、意図が読み取りにくい
- 機能差異を避けながら構造を大きく整理したい

## 決定

- 初期化フロー、アラーム登録、ランタイムメッセージルーティング、DoH監視を専用モジュールに分割する
- entrypoint は依存関係の結線に限定し、各モジュールに責務を委譲する
- 既存の公開API/イベントの振る舞いは維持する

## 理由

- 可読性: 責務ごとの境界を明確にし、変更対象を限定できる
- 変更容易性: 起動順序やルーティングの変更を局所化できる
- 安全性: 既存挙動を維持したまま構造を再編成できる

## リスクと対応

| リスク | 対応 |
|--------|------|
| 初期化順序の変更による副作用 | 初期化呼び出し順を既存通りに保持する |
| 依存の結線ミス | 依存を明示的にバインドし、型で検出する |
