# ADR-033: 外部通信制御ポリシー

## ステータス
Accepted

## コンテキスト

pleno-auditはプライバシー保護を最優先とするブラウザセキュリティツールである。
ユーザーのブラウジングデータは機密性が高く、外部サーバーへの送信は原則として禁止する必要がある。

一方で、以下の機能要件が存在する：

### OSS版（pleno-audit）
- NRD検出精度向上のためのRDAP問い合わせ
- リモートAPI同期（複数デバイス間でのデータ共有）
- CSP違反レポートの外部送信

### Enterprise版（pleno-audit-internal）
- SIEM連携（Splunk、Wiz等へのログ送信）
- SSO認証（OIDC/SAML）
- 外部統合（Slack、Jira、GitHub）
- Webhook通知

これらの機能は本質的に外部通信を必要とするが、プライバシー保護の原則と両立させる必要がある。

## 決定

### 根本原則（Fundamental Principle）

**デフォルトで外部通信を禁止する**

この原則は、OSS版・Enterprise版の両方に適用される。
ユーザーのプライバシーを最優先し、外部通信は明示的な有効化なしには発生しない。

### 制御方式の棲み分け

| 版 | 制御方式 | 有効化主体 | 対象ユーザー |
|----|---------|-----------|------------|
| OSS版 | **オプトイン** | ユーザー本人 | 個人・小規模チーム |
| Enterprise版 | **ポリシーベース** | 管理者 | 組織・大規模チーム |

### OSS版の制御フロー

```
1. デフォルト状態: 全ての外部通信が無効
2. ユーザーが設定画面で機能を有効化（オプトイン）
3. プライバシーポリシーへの同意確認
4. 外部通信の開始
```

**実装**:
- `oxlint` で外部通信を静的検出
- `.oxlintrc.json` で明示的に除外された機能のみ実装可能
- ユーザー設定は `chrome.storage.local` に保存

### Enterprise版の制御フロー

```
1. デフォルト状態: 全ての外部通信が無効
2. 管理者がポリシーで機能を有効化
3. エンドユーザーが同意画面で承認
4. プライバシーポリシーに記載された範囲でのみ通信
```

**実装**:
- ポリシーエンジンが管理者設定を解釈
- ユーザー同意の記録を保持
- 外部通信のログを監査証跡として保存

**注記（Enterprise版）**:
- SIEM等への送信先は組織内部のエンドポイント
- 企業デバイス・雇用契約により包括的同意取得済み
- 送信データの内容は組織のセキュリティ要件に基づく

## ゼロトラストとの関係

### ローカル型ゼロトラストの実装

pleno-auditは「ローカル型ゼロトラスト」を実装する。

**ローカル型ゼロトラスト**:
- ブラウザ内での継続的な脅威検証
- セッション単位のアクセス制御
- デバイス整合性監視（拡張機能、DoH等）
- **外部通信なしでゼロトラストの原則を実現**

**ネットワーク型への拡張**:
- Enterprise版では、管理者がポリシーで明示的に有効化した場合、SIEM連携等のネットワーク型ゼロトラストに拡張可能
- ローカル型の機能をベースとして、組織全体への可視性を追加

### NISTゼロトラスト原則7との整合性

NIST SP 800-207 原則7:
> 企業は、資産・ネットワークインフラ・通信の状態について可能な限り多くの情報を収集し、セキュリティを高めるために利用する

**pleno-auditの実装**:
- **「収集」≠「外部送信」**: ローカルでの情報収集も原則7を満たす
- OSS版: ブラウザ内でCSP違反、ネットワークリクエスト、AIプロンプト等を収集・分析
- Enterprise版: ローカル収集に加え、管理者ポリシーによりSIEMへの送信も可能

**差別化要因**:
- 従来のゼロトラスト実装: 外部SIEM送信が前提
- pleno-audit: ローカル完結も可能（個人のプライバシー保護）
- スケーラビリティ: 個人 → 小規模チーム → 大企業へ段階的に拡張可能

## 理由

### 1. プライバシー保護の明確化

「デフォルト禁止」を原則とすることで、ユーザーの信頼を獲得する。
- ユーザーは「何も設定しなければデータが外部に送信されない」ことを確信できる
- プライバシーポリシーの説明責任が明確になる

### 2. 規制遵守

GDPR、CCPA等のプライバシー規制は「必要最小限の原則」を要求する。
- デフォルト禁止により、データ保護影響評価（DPIA）が簡略化される
- ユーザー同意の取得プロセスが明確化される

### 3. OSS版とEnterprise版の整合性

両者が同じ原則を共有することで、以下が実現できる：
- OSS版ユーザーがEnterprise版にアップグレードする際の信頼維持
- コードベースの一貫性（外部通信ロジックの共通化）
- ドキュメントの統一性

### 4. セキュリティ

外部通信を最小化することで、以下のリスクを軽減する：
- 中間者攻撃（MITM）
- 外部サービスのブレーチによるデータ漏洩
- ネットワーク監視による情報露出

## 結果

### 期待される効果

1. **ユーザー信頼の向上**
   - 「プライバシー第一」の原則が明確化される
   - 競合製品との差別化

2. **規制遵守の簡素化**
   - GDPR、CCPA等への対応が容易になる
   - プライバシーポリシーの記述が明確化される

3. **開発プロセスの明確化**
   - 外部通信を追加する際の判断基準が明確
   - レビューで「デフォルト禁止」原則への準拠を確認可能

### 影響を受けるコンポーネント

#### OSS版
- `packages/nrd/src/rdap.ts` - RDAP問い合わせ
- `packages/extension-runtime/src/api-client.ts` - リモート API
- `packages/csp/src/reporter.ts` - CSP レポート送信

#### Enterprise版
- `packages/siem-logger/` - SIEM 連携
- `packages/enterprise-runtime/src/sso-manager.ts` - SSO 認証
- `packages/integrations/` - 外部統合

### 移行作業

既存コードは既に原則に準拠しているため、移行作業は不要。
ただし、以下のドキュメント更新が必要：

1. ✅ `CLAUDE.md` の更新（完了）
2. ✅ `PRIVACY.md` の確認（必要に応じて更新）
3. ✅ `.oxlintrc.json` のコメント明確化（必要に応じて）

## 関連ADR

- ADR-003: Enterprise境界の設定とリポジトリ分離
- ADR-004: プライバシーポリシー検出
