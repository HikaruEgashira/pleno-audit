# ADR 035: Background Service Workerのメッセージルーター化

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/entrypoints/background.ts` はメッセージ受信処理が巨大な `if` 連鎖で構成される
- 各分岐で `try/catch` とフォールバックレスポンスが重複し、変更時に挙動差異を混入しやすい
- 初期化処理とアラーム処理も同一スコープで密結合し、責務境界が曖昧である

## 決定

1. Service Workerのメッセージ処理を `sync` / `async` のルーティングテーブルで管理する
2. 非同期ハンドラーのエラーハンドリングを `withMessageFallback` に統一し、メッセージ種別ごとのフォールバック値を明示する
3. 初期化処理（API client、Sync manager、Enterprise、CSP reporter、イベント移行）を専用関数へ分割する
4. アラーム処理をハンドラーテーブル化し、アラーム名と処理の対応を単一箇所に集約する

## 理由

- 可読性: 分岐列挙ではなくテーブル定義で全ハンドラーを俯瞰できる
- 凝集度: 初期化・アラーム・メッセージ処理の責務を分離できる
- 変更容易性: ハンドラー追加時に影響範囲が限定され、フォールバック漏れを防止できる
- 機能同一性: フォールバック値と戻り値契約を既存仕様に揃えることで挙動差異を抑制できる

## リスクと対応

| リスク | 対応 |
|--------|------|
| テーブル定義の誤登録でメッセージ未処理になる | 未知メッセージを必ず `warn` ログに出力する |
| 共通フォールバックで詳細エラーが見えにくくなる | `message.type` 付きの `debug` ログを残す |
| 非同期レスポンス契約の破壊 | `chrome.runtime.onMessage` で `return true` / `false` を従来契約に合わせる |

