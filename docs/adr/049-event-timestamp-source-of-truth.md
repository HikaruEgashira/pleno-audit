# ADR 049: イベント時刻の単一責務化

## ステータス

Accepted

## コンテキスト

- イベント種別ごとに `Date.now()` の利用方針が不統一である
- `timestamp` を持つ入力でも、保存時に現在時刻へ上書きされる経路がある
- その結果、過去に発生したイベントが最新時間帯に偏って表示される問題がある

## 決定

- イベント時刻の解決を `resolveEventTimestamp` に集約する
- イベント時刻の優先順位を以下に統一する
  1. 入力イベントに含まれる時刻
  2. 検知器の `checkedAt` などの確定時刻
  3. 取り込み時刻（`Date.now()`）
- `Date.now()` による補完は最終保存層のみで許可し、fallback 発火時は警告ログを出す

## 理由

- 時刻解決ロジックを単一化すると、カテゴリ間の挙動差分をなくせる
- fallback を一箇所に限定すると、欠損時刻の検出と原因追跡が容易になる
- 保存時刻の整合性が上がることで、時系列分析と通知の信頼性が上がる

## リスクと対応

| リスク | 対応 |
|--------|------|
| 既存データの時刻揺れ | 既存データは移行せず、新規イベントから統一ルールを適用する |
| 非ISO形式の入力時刻 | 解析できない場合は取り込み時刻へフォールバックし警告ログで可視化する |

## 関連

- PR: TBD
