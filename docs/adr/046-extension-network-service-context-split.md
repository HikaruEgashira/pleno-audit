# ADR 046: Extension Network Serviceの責務分割をContextで統一する

## ステータス

Accepted

## コンテキスト

- `extension-network-service` が監視・バッファ・永続化・リスク分析・統計の状態を単一ファイルに保持している
- 変更時に副作用の境界が見えにくく、状態の共有経路が暗黙になりやすい
- 監視と分析の変更を並行する場面で、責務の見通しとレビュー負荷を下げる必要がある

## 決定

- `extension-network-service` を「監視」「リクエスト取得」「リスク分析」「統計」「クールダウン」に分割する
- 状態は `ExtensionNetworkContext` で統一し、各モジュールはContext越しに依存関係と状態へアクセスする
- 公開APIは既存インターフェースを維持し、`background.ts` の契約差異を発生させない

## 理由

- 見通し: 変更の影響範囲をモジュール単位で局所化できる
- 変更容易性: 監視・分析・保存の改修を独立に進められる
- 安全性: 状態の共有経路をContextに集約し、暗黙依存を減らす

## リスクと対応

| リスク | 対応 |
|--------|------|
| ファイル分割で参照経路が増える | Contextを単一入口にして依存関係を明示する |
| モジュール間の循環参照 | 「requests → risk/stats」「monitor → requests」など一方向依存に限定する |
| 動作差異の混入 | 既存の公開APIと処理順を維持し、拡張の実動作で確認する |
