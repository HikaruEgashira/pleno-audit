# ADR-015: Pleno Battacker - ブラウザ防御耐性テストツール

## ステータス
Accepted

## コンテキスト

ブラウザセキュリティ拡張機能（Pleno Audit）の防御能力を評価する手段がなかった。

1. **防御力の定量化が困難** - ユーザーはPleno Auditがどの程度の攻撃を防げるか判断できない
2. **検証手段の欠如** - 実際の攻撃パターンをテストする安全な方法がない
3. **継続的な評価の必要性** - セキュリティ設定変更後の影響を測定したい

[browsertotal.com](https://browsertotal.com/)に着想を得て、**実際の攻撃パターンをシミュレート**し、防御能力を数値化するツールが必要。

## 決定

### 概要

`app/pleno-battacker/`として、ブラウザ防御耐性テストツールを実装する。

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    Pleno Battacker                       │
├─────────────────────────────────────────────────────────┤
│  UI Layer                                                │
│  ├── popup/    → 総合スコア・クイック結果表示            │
│  └── dashboard/→ 詳細分析・履歴・カテゴリ別結果          │
├─────────────────────────────────────────────────────────┤
│  Core Layer                                              │
│  ├── background.ts → テスト実行エンジン                  │
│  ├── scorer.ts     → スコア計算ロジック                  │
│  └── attacks/      → 攻撃シミュレーションモジュール      │
├─────────────────────────────────────────────────────────┤
│  Storage Layer                                           │
│  └── Chrome Storage Local → 結果・履歴保存（30日保持）  │
└─────────────────────────────────────────────────────────┘
```

### 5つの攻撃カテゴリ

| カテゴリ | 重み | 内容 |
|---------|------|------|
| **Network** | 25% | Beacon送信、データ漏洩、C2通信シミュレーション |
| **Phishing** | 25% | タブナビング、クリップボード操作、履歴アクセス |
| **ClientSide** | 20% | XSS、DOM操作、Cookie盗取 |
| **Extension** | 15% | 拡張機能列挙、ストレージアクセス |
| **Download** | 15% | Blob URL、Data URL、疑わしいファイル生成 |

### スコアリングシステム

各攻撃の結果を3段階で評価：

| 結果 | 意味 | 重み |
|------|------|------|
| `blocked` | 攻撃がブロックされた | 1.0 |
| `detected` | 検出されたがブロックされず | 0.5 |
| `success` | 攻撃が成功した | 0.0 |

**総合スコア計算:**
```
総合スコア = Σ(カテゴリスコア × カテゴリ重み) × 100

カテゴリスコア = Σ(攻撃結果重み × 攻撃重み) / Σ(攻撃重み)
```

**グレード判定:**
| スコア | グレード |
|--------|----------|
| 90-100 | A |
| 80-89 | B |
| 70-79 | C |
| 60-69 | D |
| 0-59 | F |

### oxlint例外設定

Battackerは意図的に攻撃パターンをシミュレートするため、外部通信禁止ポリシーの例外とする。

```json
{
  "files": ["app/pleno-battacker/**/*"],
  "rules": { "no-console": "off", "no-restricted-globals": "off" }
}
```

### 検討した代替案

| 方式 | メリット | デメリット |
|------|---------|-----------|
| **外部サービス連携** | 最新の攻撃パターン | プライバシーポリシー違反、外部依存 |
| **静的チェック** | シンプル | 実際の防御能力を測定できない |
| **攻撃シミュレーション** ✅ | 実際の防御力を定量化 | 実装コスト、誤検知の可能性 |

攻撃シミュレーションを選択した理由：
- ローカルで完結（プライバシーポリシー準拠）
- 実際のブラウザ動作に基づく評価
- 新しい攻撃パターンを追加可能

### ファイル構成

```
app/pleno-battacker/
├── entrypoints/
│   ├── background.ts      # テスト実行エンジン
│   ├── popup/             # ポップアップUI
│   │   ├── App.tsx
│   │   └── styles.ts
│   └── dashboard/         # ダッシュボードUI
│       ├── App.tsx
│       └── style.css
├── lib/
│   ├── types.ts           # 型定義
│   ├── scorer.ts          # スコア計算
│   └── attacks/           # 攻撃モジュール
│       ├── index.ts
│       ├── network.ts     # ネットワーク攻撃
│       ├── phishing.ts    # フィッシング攻撃
│       ├── client-side.ts # クライアントサイド攻撃
│       ├── extension.ts   # 拡張機能悪用
│       └── download.ts    # ダウンロード攻撃
├── components/            # 共通UIコンポーネント
└── wxt.config.ts
```

## 結果

- ユーザーが防御能力を0-100のスコアで把握可能
- カテゴリ別に弱点を特定し、対策を講じられる
- 30日間の履歴で防御力の推移を確認可能
- ローカル完結でプライバシーを保護

## 使用例

```bash
# 拡張機能をビルド
pnpm --filter pleno-battacker build

# 開発モードで起動
pnpm --filter pleno-battacker dev
```

### UI操作

1. ポップアップで「Execute Scan」をクリック
2. テストが実行され、総合スコアが表示
3. 「Details」でダッシュボードを開き、詳細分析を確認
