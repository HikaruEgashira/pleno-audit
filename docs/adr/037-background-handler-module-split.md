# ADR 037: Backgroundハンドラ定義のモジュール分割

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/entrypoints/background.ts` はランタイムメッセージ定義とアラーム定義を同一ファイル内に保持する
- ハンドラ一覧の変更は背景処理の本体ロジックと同時にレビュー対象となり、変更影響の見通しが悪い
- フォールバック値と依存関係の境界が暗黙で、設定追加時の回帰リスクが高い

## 決定

- ランタイムメッセージ定義を `app/audit-extension/lib/background/runtime-handlers.ts` に分離する
- アラーム定義を `app/audit-extension/lib/background/alarm-handlers.ts` に分離する
- `background.ts` は依存関係を明示的に注入し、起動・監視・ストレージ更新の本体ロジックに集中する
- デフォルト設定値は `fallbacks` として一箇所で定義し、メッセージごとのフォールバックを統一する

## 理由

- 可読性: メッセージ定義と実処理を分離し、探索コストを下げる
- 凝集度: ルーティング責務を専用モジュールに集約できる
- 変更容易性: 新規メッセージ追加時の差分をハンドラ定義ファイルに限定できる
- パフォーマンス: 実行時挙動は維持しつつ、不要な条件分岐の追跡コストを減らす

## リスクと対応

| リスク | 対応 |
|--------|------|
| 依存注入漏れで実行時エラーになる | `runtime-handlers.ts` で依存インターフェースを型で固定し、起動時に一括注入する |
| フォールバック値の不整合が生じる | `fallbacks` を集約し、既存の既定値をそのまま再利用する |
| モジュール分割でメッセージ互換性が崩れる | 既存メッセージ名・戻り値・失敗時レスポンスを変更しない |
