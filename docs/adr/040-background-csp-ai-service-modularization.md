# ADR-040: BackgroundのCSP/AI監視責務をサービスへ分離する

## ステータス
採用

## コンテキスト
`app/audit-extension/entrypoints/background.ts` は CSP レポート処理と AI プロンプト監視を同時に持ち、
メッセージルーティング、ストレージ管理、通知、ポリシー評価が1ファイルに集中している。
この構造は以下の問題を生む。

- 責務境界が曖昧で、変更時に影響範囲の見積もりが難しい
- 監視機能ごとの状態管理（キュー、タイマー、保存上限）が読み取りづらい
- ルーティング層のレビュー時に業務ロジックまで追う必要があり、認知負荷が高い

## 決定
CSP と AI 監視の業務ロジックをサービスモジュールへ分離する。

- `app/audit-extension/lib/background/csp-reporting-service.ts`
  - CSP違反/ネットワークリクエスト保存
  - キュー送信、ポリシー再生成、設定更新
- `app/audit-extension/lib/background/ai-prompt-monitor-service.ts`
  - AIプロンプト保存
  - Shadow AI / 機密情報検知イベント発行
  - サービス情報更新

`background.ts` は依存注入とメッセージ接続に集中する。

## 理由
- 凝集度: 監視機能ごとに状態と振る舞いを閉じ込める
- 変更容易性: CSP/AIの機能改修が他ハンドラに波及しにくい
- 可読性: ルーティングと業務ロジックを分離し、追跡経路を短縮する
- 性能維持: 既存のキュー処理・デバウンス・保存戦略を維持し、実行特性を変えない

## リスクと対応
- リスク: 依存注入の型が緩すぎると実行時不整合が隠れる
- 対応（軽減）: build と実動デバッグでメッセージ経路を確認し、サービスの公開APIを最小化する
