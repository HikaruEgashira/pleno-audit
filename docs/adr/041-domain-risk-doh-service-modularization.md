# ADR-041: Domain Risk/DoH監視のサービス分離

## ステータス
採用

## コンテキスト
`app/audit-extension/entrypoints/background.ts` に NRD / Typosquatting 検知と DoH 監視の状態管理が混在し、
ストレージ更新、通知、アラート発火、Parquet書き込みが同一ファイルに集中している。
この構造は以下の問題を生む。

- 監視ロジックの変更がルーティング層へ波及しやすい
- NRD/タイポ検知のキャッシュ・再初期化・永続化が散らばり理解に時間がかかる
- DoH監視の保存・通知・設定更新が一体化し、保守の粒度が粗い

## 決定
NRD/タイポ検知と DoH 監視の業務ロジックをサービスモジュールへ分離する。

- `app/audit-extension/lib/background/domain-risk-service.ts`
  - NRD/タイポ検知の初期化、判定、イベント/アラート発火、Parquet記録
  - 設定更新とキャッシュ管理
- `app/audit-extension/lib/background/doh-monitor-service.ts`
  - DoH監視の設定取得/更新、検知ログの保持、通知発火

`background.ts` は依存注入とメッセージ接続に集中する。

## 理由
- 凝集度: 監視機能ごとに状態と振る舞いを閉じ込める
- 変更容易性: 監視ロジックの改修がルーティングに波及しにくい
- 可読性: ルーティング層の責務を明確にし、追跡経路を短縮する
- 実行特性維持: キャッシュ、通知、保存戦略を変更せず既存挙動を保持する

## リスクと対応
- リスク: 依存注入の疎結合化で初期化順序の不整合が隠れる
- 対応（軽減）: build とデバッグでメッセージ経路を確認し、公開APIを最小化する
