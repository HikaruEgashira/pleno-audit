# ADR 048: Backgroundエントリーポイントの責務をオーケストレーションに集約する

## ステータス

Accepted

## コンテキスト

- `entrypoints/background.ts` が初期化・設定・監視・Runtimeハンドラ・DoH/Networkの永続化まで1ファイルに集約され、変更単位が肥大化している
- MV3のService Workerライフサイクルに合わせた初期化順序が暗黙的で、レビュー時に意図確認のコストが高い
- 同じ依存群（logger、storage、services）を複数箇所で組み立てており、後続改善の足かせになる

## 決定

- Backgroundのエントリーポイントは「オーケストレーション（呼び出し順序の制御）」に限定する
- 初期化/監視/Runtime依存の組み立ては `lib/background/entrypoint` 配下のモジュールへ分割する
- 既存のRuntime APIと動作順序は保持し、機能差異を出さない

## 理由

- 可読性: 役割単位で責務を分割し、変更点の把握を容易にする
- 安全性: 初期化順序と依存関係を明示化し、MV3の起動時挙動を崩しにくくする
- 拡張性: 新規ハンドラや監視の追加がエントリーポイント肥大化につながらない

## リスクと対応

| リスク | 対応 |
|--------|------|
| ファイル分割により探索性が下がる | `lib/background/entrypoint` に集約し命名規則を統一する |
| 初期化順序のズレで機能差異が出る | 既存の順序を `background.ts` で維持し、責務の移動のみに留める |
| 依存の循環参照 | Context生成を起点にし、依存方向を一方向に整理する |
