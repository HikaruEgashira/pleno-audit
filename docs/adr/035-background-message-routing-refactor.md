# ADR 035: Backgroundメッセージルーティングのテーブル駆動化

## ステータス

Accepted

## コンテキスト

- `app/audit-extension/entrypoints/background.ts` は `chrome.runtime.onMessage` に大量の条件分岐を持つ
- 同一パターンのエラーハンドリングとフォールバックが重複し、変更時の確認範囲が広い
- 拡張機能リスク分析でも同形の変換・グルーピング処理が散在し、凝集度が低い

## 決定

- ランタイムメッセージ処理を `direct` と `async` のハンドラマップに分離し、ディスパッチを共通化する
- 非同期ハンドラの応答パターンを `runAsyncMessageHandler` に集約し、フォールバック方針を明示する
- アラーム処理を `createAlarmHandlers` でテーブル化し、分岐を簡素化する
- 拡張機能リスク分析の変換・グルーピング処理を共通関数へ抽出する

## 理由

- 可読性: 巨大な逐次分岐より、責務ごとのハンドラ定義の方が追跡しやすい
- 変更容易性: 新規メッセージ追加時の差分をハンドラ1件に限定できる
- 一貫性: エラー時のレスポンス形を統一し、挙動差分を抑制できる
- 凝集度: 拡張機能リスク分析の重複処理を集約し、保守コストを下げる

## リスクと対応

| リスク | 対応 |
|--------|------|
| 既存メッセージの戻り値互換性が崩れる | 既存フォールバック値を維持し、実動で設定更新経路を確認する |
| ルーティングの見落としで未処理メッセージが発生する | 未知メッセージは警告ログを維持し、検知可能性を担保する |
